<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Tableau de bord | Inventaire</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="css/navb.css"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->

    <style>
      html,
        body {
          height: 100%;
          margin: 0;
          padding: 0;
        }
        body {
          background: #f8f9fa;
        }
         .chart-container {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

        .dashboard-header {
          margin-top: 20px;
        }

        .card {
          border: none;
          border-radius: 15px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        }

        .card i {
          font-size: 2rem;
        }

        .data-section {
          margin-top: 30px;
        }
        .hh{
          margin-bottom: 150px;
        }
         #sharedTable tr td,
         #sharedTable tr th{
          font-size :20px;
          text-align: center;
          font-weight: 700;
          vertical-align: center;
        }


        @media (max-width: 768px) {
          .card i {
            font-size: 1.5rem;
          }
        .chart {
          box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
        }
    </style>
  </head>

  <body>
    <div class="container-fluid p-4">
      <h2 class="text-center dashboard-header">
        <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        />
        <i class="fas fa-chart-line text-primary"></i> Tableau de bord
      </h2>

      <!-- Cards statistiques -->
      <div
        class="row text-center mt-4"
        id="stats-cards"
      >
        <div class="col-md-3 col-6 mb-3 usersCount">
          <div class="card text-bg-primary p-3">
            <i class="fas fa-users mb-2"></i>
            <h5>Utilisateurs</h5>
            <h3 id="usersCount">0</h3>
          </div>
        </div>

        <div class="col-md-3 col-6 mb-3">
          <div class="card text-bg-success p-3">
            <i class="fas fa-boxes-stacked mb-2"></i>
            <h5>Produits</h5>
            <h3 id="productsCount">0</h3>
          </div>
        </div>

        <div class="col-md-3 col-6 mb-3">
          <div class="card text-bg-warning p-3">
            <i class="fa-solid fa-at"></i>
            <h5>NÂ° Adress</h5>
            <h3 id="adressCount">0 / 686</h3>
          </div>
        </div>

        <div class="col-md-3 col-6 mb-3 Adresses">
          <div class="card text-bg-danger p-3">
            <i class="fas fa-map-marker-alt mb-2"></i>
            <h5>Adresses partagÃ©es</h5>
            <h3 id="sharedAddresses">0</h3>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="container-fluid my-5">
        <div class="card chart border-0 rounded-4">
          <div class="card-body">
            <h5 class="card-title text-center mb-4">
              <i class="fas fa-map-marker-alt text-success"></i>
              Statistiques des adresses utilisÃ©es
            </h5>
            <div style="height: 400px; overflow-x: auto">
              <canvas
                id="adressChart"
                style="max-height: 400px; width: 100%"
              ></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="container-fluid my-5">
        <div class="card chart border-0 rounded-4">
          <div class="card-body">
            <h5 class="card-title text-center mb-4">
              <i class="fas fa-chart-bar text-primary"></i> Comparaison entre le nombre total de
              produits et les produits extraits
            </h5>
            <div class="chart-container">
              <canvas id="countProduct"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="container-fluid my-5">
        <div class="card chart border-0 rounded-4">
          <div class="card-body">
            <h5 class="card-title text-center mb-4">
              <i class="fas fa-chart-bar text-primary"></i> Comparaison des adresses rÃ©elles et de
              lâ€™objectif par rayon
            </h5>
            <div class="chart-container">
              <canvas id="rayonChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="container-fluid my-5">
        <div class="card chart border-0 rounded-4">
          <div class="card-body">
            <h5 class="card-title text-center mb-4">
              <i class="fas fa-chart-bar text-primary"></i> Top 10 vendeurs par nombre de produits
            </h5>
            <div style="height: 400px; overflow-x: auto">
              <canvas
                id="vendeurChart"
                style="max-height: 400px; width: 100%"
              ></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Tableau des adresses partagÃ©es -->
      <div class="data-section hh">
        <div class="card p-3">
          <h5 class="mb-3"><i class="fas fa-location-dot text-danger"></i> Adresses partagÃ©es</h5>
          <div class="table-responsive">
            <table
              id="sharedTable"
              class="table table-striped table-bordered"
              style="width: 100%"
            >
              <thead class="table-dark">
                <tr>
                  <th>Adresse</th>
                  <th>Vendeurs</th>
                  <th>NÂ° Vendeurs</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!--nav FAB Button -->
    <div
      class="containeer"
      style="zoom: 1.7"
    >
      <div class="menu-toggle">
        <span class="fa fa-plus"></span>
      </div>

      <div class="menu-round">
        <div
          class="btn-app"
          data-label="Album"
        >
          <div class="fa">
            <a href="galerie"
              ><i
                class="fas fa-file-image"
                style="color: white"
              ></i
            ></a>
          </div>
        </div>
        <div
          class="btn-app"
          data-label="mis Ã  jour Data"
        >
          <div class="fa">
            <a href="upload"
              ><i
                class="fas fa-file-arrow-up"
                style="color: white"
              ></i
            ></a>
          </div>
        </div>
        <div
          class="btn-app"
          data-label="DÃ©connexion"
        >
          <div class="fa">
            <a href="logout"
              ><i
                class="fas fa-sign-out-alt"
                style="color: white"
              ></i
            ></a>
          </div>
        </div>
      </div>

      <div class="menu-line">
        <div
          class="btn-app"
          data-label="Recherche Produits"
        >
          <div class="fa">
            <a href="CHERCHER"
              ><i
                class="fas fa-search"
                style="color: white"
              ></i
            ></a>
          </div>
        </div>
        <div
          class="btn-app"
          data-label="dashboard Inventaire"
        >
          <div class="fa">
            <a href="/dashboard"
              ><i
                class="fa-solid fa-chart-line"
                style="color: white"
              ></i>
            </a>
          </div>
        </div>
        <div
          class="btn-app"
          data-label="Inventaire Fournisseurs"
        >
          <div class="fa">
            <a href="cmd"
              ><i
                class="far fa-file-excel"
                style="color: white"
              ></i
            ></a>
          </div>
        </div>
        <div
          class="btn-app"
          data-label="Prix Vente"
        >
          <div class="fa">
            <a href="prix"
              ><i
                class="fas fa-cash-register"
                style="color: white"
              ></i>
            </a>
          </div>
        </div>
      </div>
    </div>
    <!--fin FAB Button -->

    <!-- JS Libraries (ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù‡Ù…) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <!-- ØªØ£ÙƒÙ‘Ø¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ù€ canvases ÙÙŠ HTML -->
    <!-- <canvas id="vendeurChart"></canvas> -->
    <!-- <canvas id="adressChart"></canvas> -->

    <script>
      /* === Helpers & Globals === */
      function escapeHtml(unsafe) {
        if (unsafe == null) return '';
        return String(unsafe)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„ÙƒÙŠ ØªØªÙ…ÙƒÙ† Ù…Ù† ØªØ¯Ù…ÙŠØ±Ù‡Ø§ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù…
      window._charts = window._charts || { vendeur: null, adress: null };

      /* === Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ±Ø³Ù… ÙƒÙ„ Ø´ÙŠØ¡ === */
      async function initDashboard() {
        try {
          // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
          const resp = await fetch('/api/inventairePro');
          const response = await fetch('/api/Produits');

          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const produits = await resp.json();
          const data = await response.json();

          // --- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© ---
          // Ø¨Ø§Ø¦Ø¹ÙŠÙ† ÙØ±ÙŠØ¯ÙŠÙ†
          const vendeursUnique = Array.from(
            new Set(produits.map((p) => p.nameVendeur).filter(Boolean))
          );
          document.getElementById('usersCount').textContent = vendeursUnique.length;

          // Ø¹Ù†Ø§ÙˆÙŠÙ† ÙØ±ÙŠØ¯Ø©
          const adressesUnique = Array.from(
            new Set(produits.map((p) => p.adresse).filter(Boolean))
          );

          // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
          document.getElementById('productsCount').textContent =
            produits.length + ' / ' + data.count;

          const ctxB = document.getElementById('countProduct').getContext('2d');

          // Ø£Ù…Ø«Ù„Ø©: Ø¹ÙˆÙ‘Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ù…ØµØ¯Ø± Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
          let dataCount = produits.length || 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©
          let produitsLength = data?.count || 0; // Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø°ÙŠ Ù‚Ø§Ø±Ù†ØªÙ‡ Ø¨Ù‡ (ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØµØ¯Ø±Ù‡)

          // Ø­Ù…Ø§ÙŠØ©: Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ù‚ÙŠÙ… Ø³Ø§Ù„Ø¨Ø© Ø£Ùˆ ØªØ¬Ø§ÙˆØ² Ù…Ù†Ø·Ù‚
          if (produitsLength < 0) produitsLength = 0;
          if (dataCount < 0) dataCount = 0;
          if (dataCount > produitsLength) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙ†Ø§Ø³Ù‚Ø©)ØŒ Ù†Ø¶Ø¨Ø·Ù‡Ø§
            dataCount = produitsLength;
          }

          // Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù„ÙŠØµØ¨Ø­ Ø§Ù„Ø±Ø³Ù… ÙŠØ¹ÙƒØ³ Ø§Ù„Ø­ØµØ© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
          const remainder = produitsLength - dataCount;

          // Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© Ù…Ø­Ù…ÙŠØ© (0..100)
          const dataCountPercentage = produitsLength > 0 ? (dataCount / produitsLength) * 100 : 0;

          // Ø¥Ø¶Ø§ÙØ© Ù…Ø®ØµØµØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„ÙˆØ³Ø· (Chart.js v3+ compatible)
          const centerText = {
            id: 'centerText',
            beforeDraw: (chart) => {
              const { ctx, chartArea } = chart;
              if (!chartArea) return; // Ø­Ù…Ø§ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙØ­Ù…Ù‘ÙŽÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø¹Ø¯
              ctx.save();

              // Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø³Ù… Ù…Ù† chartArea (Ø£ÙƒØ«Ø± Ø«Ø¨Ø§ØªÙ‹Ø§ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… datapoint.x/y)
              const centerX = (chartArea.left + chartArea.right) / 2;
              const centerY = (chartArea.top + chartArea.bottom) / 2;

              // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Øµ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
              const percentText = `${dataCountPercentage.toFixed(2)}%`;
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';

              // Ø®Ø· Ø£ÙƒØ¨Ø± Ù„Ù„Ù†Ø³Ø¨Ø©
              ctx.font = 'bold 44px Arial';
              // Ù†ØºÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø± Ø¹Ù†Ø¯Ù…Ø§ 100%)
              ctx.fillStyle = dataCountPercentage >= 100 ? '#FF4D4D' : '#333333';
              ctx.fillText(percentText, centerX, centerY - 10);

              // Ø®Ø· Ø£ØµØºØ± Ù„Ù„ÙˆØµÙ
              ctx.font = '16px Arial';
              ctx.fillStyle = '#666';
              ctx.fillText('Part de produits extraits', centerX, centerY + 24);

              ctx.restore();
            },
          };

          // Ø£Ù„ÙˆØ§Ù†: Ù„ÙˆÙ† Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø£Ø®ÙˆØ°ØŒ ÙˆÙ„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ø¨Ø§Ù‚ÙŠ
          const mainColor = '#FF6384';
          const remainderColor = '#7062da';

          // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù…: Ù†Ù…Ø±Ù‘Ø± [taken, remaining]
          const chartData = [dataCount, remainder];

          const myChart = new Chart(ctxB, {
            type: 'doughnut',
            data: {
              labels: ['Extraits', 'Reste'],
              datasets: [
                {
                  data: chartData,
                  backgroundColor: [mainColor, remainderColor],
                  hoverBackgroundColor: [mainColor, remainderColor],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              responsive: true,
              cutout: '68%', // Ø³Ù…Ùƒ Ø§Ù„Ø­Ù„Ù‚Ø© - Ø¹Ø¯Ù‘Ù„Ù‡ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…
              plugins: {
                legend: {
                  position: 'bottom',
                },
                title: {
                  display: true,
                  text: 'Comparaison entre produitsLength et dataCount',
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const value = context.raw;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const perc = total > 0 ? ((value / total) * 100).toFixed(2) : '0.00';
                      return `${context.label}: ${value} (${perc}%)`;
                    },
                  },
                },
                // Ø¹Ø·Ù„ Ø£ÙŠ Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª datalabels Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¯Ø§Ø®Ù„
                datalabels: {
                  display: false,
                },
              },
              // Ø­Ù…Ø§ÙŠØ©: Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
              onHover: (e, activeEls) => {
                // Ù…Ø«Ø§Ù„: Ù„Ùˆ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± Ù…Ø¤Ø´Ø± Ø§Ù„ÙØ£Ø±Ø© Ø¹Ù†Ø¯Ù…Ø§ ØªÙ‚Ù ÙÙˆÙ‚ Ø¬Ø²Ø¡
                e.native.target.style.cursor = activeEls.length ? 'pointer' : 'default';
              },
            },
            plugins: [centerText],
          });

          const ctx = document.getElementById('rayonChart').getContext('2d');

          // ðŸ”¹ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ„ Rayon
          const rayons = {
            Ã‰lectricitÃ©: { regex: /^E-/i, objectif: 105 },
            Sanitaire: { regex: /^S-/i, objectif: 59 },
            Outillage: { regex: /^O-/i, objectif: 81 },
            Quin: { regex: /^Q-/i, objectif: 80 },
            Bois: { regex: /^B-/i, objectif: 8 },
            Jardin: { regex: /^J-/i, objectif: 102 },
            DÃ©corations: { regex: /^D-/i, objectif: 142 },
            Cuisine: { regex: /^C-/i, objectif: 48 },
            TG: { regex: /^TG-/i, objectif: 17 },
            Podiome: { regex: /^P-/i, objectif: 32 },
            Persentoir : { regex: /^PR-/i, objectif: 9 },
          };

          // ðŸ”¹ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù„ÙƒÙ„ rayon Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          const rayonNames = Object.keys(rayons);
          const rayonCounts = rayonNames.map(
            (rayon) =>
              produits.filter((p) => p.adresse && rayons[rayon].regex.test(p.adresse)).length
          );

          // ðŸ”¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø®ØµØµØ©
          const rayonObjectifs = rayonNames.map((rayon) => rayons[rayon].objectif);

          // ðŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ§Ù†
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: rayonNames,
              datasets: [
                {
                  label: 'Objectif par rayon',
                  data: rayonObjectifs,
                  backgroundColor: '#0ba360',
                },
                {
                  label: 'Adresses rÃ©elles',
                  data: rayonCounts,
                  backgroundColor: 'rgba(54, 162, 235, 0.8)',
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Nombre d'adresses" },
                },
              },
              plugins: {
                title: {
                  display: true,
                  text: 'Comparaison des adresses rÃ©elles et de lâ€™objectif par rayon',
                  font: { size: 18 },
                },
                legend: { position: 'bottom' },
              },
            },
          });

          document.getElementById('adressCount').textContent = `${adressesUnique.length} / 686`;

          // --- Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ø´ØªØ±ÙƒØ© (group by adresse) ---
          const groupedByAdresse = {};
          for (const p of produits) {
            if (!p.adresse) continue;
            if (!groupedByAdresse[p.adresse])
              groupedByAdresse[p.adresse] = { vendeursSet: new Set(), produitsCount: 0 };
            if (p.nameVendeur) groupedByAdresse[p.adresse].vendeursSet.add(p.nameVendeur);
            groupedByAdresse[p.adresse].produitsCount++;
          }

          const sharedEntries = Object.entries(groupedByAdresse)
            .map(([adresse, info]) => ({
              adresse,
              vendeurs: Array.from(info.vendeursSet),
              vendeursCount: info.vendeursSet.size,
              produitsCount: info.produitsCount,
            }))
            .filter((e) => e.vendeursCount > 1)
            .sort((a, b) => b.vendeursCount - a.vendeursCount || b.produitsCount - a.produitsCount);

          document.getElementById('sharedAddresses').textContent = sharedEntries.length;

          // ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
          const tbody = document.querySelector('#sharedTable tbody');
          tbody.innerHTML = sharedEntries
            .map(
              (row) => `
          <tr>
            <td class="text-bg-danger">${escapeHtml(row.adresse)}</td>
            <td class="text-bg-primary">${escapeHtml(row.vendeurs.join(' ; ').toUpperCase())}</td>
            <td class="text-bg-danger">${row.vendeursCount}</td>
          </tr>
        `
            )
            .join('');

          // ØªÙ‡ÙŠØ¦Ø© DataTable Ø¨Ø£Ù…Ø§Ù† (destroy Ø¥Ù† ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯)
          if ($.fn.dataTable && $.fn.dataTable.isDataTable('#sharedTable')) {
            $('#sharedTable').DataTable().clear().destroy();
          }
          $('#sharedTable').DataTable({
            pageLength: 5,
            responsive: true,
            lengthMenu: [5, 10, 25],
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json' },
          });

          // --- Ø±Ø³Ù… Ù…Ø®Ø·Ø· Top10 vendeurs (Bar vertical) ---
          const vendeursCountMap = {};
          for (const p of produits) {
            if (!p.nameVendeur) continue;
            vendeursCountMap[p.nameVendeur] = (vendeursCountMap[p.nameVendeur] || 0) + 1;
          }
          const top10 = Object.entries(vendeursCountMap)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
          const topLabels = top10.map((v) => v[0]);
          const topValues = top10.map((v) => v[1]);

          // Ø¯Ù…Ø± Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆÙØ¬Ø¯
          if (window._charts.vendeur) {
            try {
              window._charts.vendeur.destroy();
            } catch (e) {
              /* ignore */
            }
            window._charts.vendeur = null;
          }

          const ctxV = document.getElementById('vendeurChart')?.getContext('2d');
          if (ctxV) {
            window._charts.vendeur = new Chart(ctxV, {
              type: 'bar',
              data: {
                labels: topLabels,
                datasets: [
                  {
                    label: 'Nombre de produits',
                    data: topValues,
                    backgroundColor: [
                      '#1abc9c', // turquoise
                      '#3498db', // blue
                      '#9b59b6', // purple
                      '#e67e22', // orange
                      '#e74c3c', // red
                      '#2ecc71', // green
                      '#16a085', // teal
                      '#f1c40f', // yellow
                      '#2980b9', // deep blue
                      '#8e44ad', // violet
                      '#d35400', // dark orange
                      '#27ae60', // emerald
                      '#c0392b', // dark red
                      '#f39c12', // amber
                      '#7f8c8d', // gray
                    ],

                    borderColor: 'rgba(0,0,0,0.2)',
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    ticks: { autoSkip: true, maxRotation: 45, minRotation: 30, font: { size: 12 } },
                  },
                  y: {
                    beginAtZero: true,
                    ticks: { precision: 0, stepSize: 1 },
                  },
                },
                plugins: {
                  legend: { display: false },
                  title: { display: true, text: 'Top 10 vendeurs (par nombre de produits)' },
                  tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.y} produits` } },
                },
              },
            });
          }

          // --- Ø±Ø³Ù… Ù…Ø®Ø·Ø· Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Horizontal bar Ø«Ø§Ø¨Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ = 686) ---
          const adresseCount = adressesUnique.length;

          // Ø¯Ù…Ø± Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆÙØ¬Ø¯
          if (window._charts.adress) {
            try {
              window._charts.adress.destroy();
            } catch (e) {
              /* ignore */
            }
            window._charts.adress = null;
          }

          const ctxA = document.getElementById('adressChart')?.getContext('2d');

          if (ctxA) {
            const totalAdresses = 686; // Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            const percentageUsed = ((adresseCount / totalAdresses) * 100).toFixed(2); // Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
            window._charts.adress = new Chart(ctxA, {
              type: 'bar',
              data: {
                labels: ['Adresses utilisÃ©es', 'CapacitÃ© totale'],
                datasets: [
                  {
                    label: 'Adresses',
                    data: [adresseCount, totalAdresses],
                    backgroundColor: ['#2575fc', '#4facfe'],
                    borderColor: ['rgba(0,0,0,0.15)', 'rgba(0,0,0,0.15)'],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                indexAxis: 'y', // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø£ÙÙ‚ÙŠØ©
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    beginAtZero: true,
                    max: totalAdresses,
                    ticks: { stepSize: Math.max(1, Math.ceil(totalAdresses / 7)) }, // Ø®Ø·ÙˆØ© Ù…Ù‚Ø§Ø±Ø¨Ø©
                  },
                  y: { grid: { display: false } },
                },
                plugins: {
                  legend: { display: false },
                  title: {
                    display: true,
                    // Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                    text: `Utilisation des adresses (sur ${totalAdresses}) - ${percentageUsed}% utilisÃ©s`,
                    font: {
                      size: 24,
                      weight: 'bold', // Ø¬Ø¹Ù„ Ø§Ù„Ù†Øµ Ø¹Ø±ÙŠØ¶Ù‹Ø§
                    },
                    color: '#2575fc', // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
                  },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => {
                        const value = ctx.parsed.x;
                        const percentage = ((value / totalAdresses) * 100).toFixed(2);
                        return `${value} adresses (${percentage}%)`;
                      },
                    },
                  },
                },
              },
            });
          }
        } catch (err) {
          console.error('Erreur lors du chargement du dashboard:', err);
          const container = document.querySelector('.container-fluid') || document.body;
          const errEl = document.createElement('div');
          errEl.className = 'alert alert-danger mt-3';
          errEl.textContent = 'Erreur lors du chargement du dashboard. VÃ©rifiez la console.';
          container.prepend(errEl);
        }
      }

      document.querySelector('.usersCount').addEventListener('click', () => {
        window.location.href = '/listVendeurs';
      });
      document.querySelector('.Adresses').addEventListener('click', () => {
        window.location.href = '#sharedTable';
        console.log('hello');
      });

      /* Ø´ØºÙ‘Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ù†Ø§Ø¡ */
      document.addEventListener('DOMContentLoaded', initDashboard);

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
      //setInterval(initDashboard, 5000);
    </script>

    <script src="js/main2.js"></script>
  </body>
</html>
