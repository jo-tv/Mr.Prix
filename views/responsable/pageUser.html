<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=0.5"
    />
    <meta
      http-equiv="X-UA-Compatible"
      content="IE=edge"
    />

    <!-- üåê Title -->
    <title>Gestion des vendeurs ‚Äî Inventaire</title>

    <!-- üé® Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- üìä DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />

    <!-- üìé Buttons CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css"
    />

    <!-- üé≠ Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <!-- üìå jQuery (Ÿäÿ¨ÿ® Ÿàÿ∂ÿπŸá ŸÇÿ®ŸÑ DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- üìä DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- ‚¨áÔ∏è Buttons JS -->
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <!-- ÿ≤ÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ© -->
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <!-- code css nav bar  -->
    <link
      rel="stylesheet"
      href="/css/navb.css"
    />
    <style>
      body {
        background: #f8f9fa;
        text-align: center;
      }
      .password-box {
        letter-spacing: 3px;
        font-weight: bold;
      }
      table {
        font-size: 22px;
        font-weight: 600;
        letter-spacing: 1px;
      }
    </style>
  </head>
  <!-- ÿÆŸÑŸÅŸäÿ© ÿ™ÿ∫ÿ∑Ÿä ÿßŸÑÿ¥ÿßÿ¥ÿ© -->
  <div
    id="passwordOverlay"
    style="
      position: fixed;
      inset: 0;
      background: rgb(128, 120, 120);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    "
  >
    <div
      style="
        background: white;
        padding: 25px;
        border-radius: 10px;
        width: 80%;
        margin: 0 auto;
        text-align: center;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      "
    >
      <h3>üîê Acc√®s prot√©g√©</h3>
      <p>Veuillez entrer le mot de passe :</p>
      <input
        id="passwordInput"
        type="password"
        style="
          width: 100%;
          padding: 10px;
          margin: 10px 0;
          border-radius: 8px;
          border: 1px solid #aaa;
        "
      />
      <button
        onclick="submitPassword()"
        style="
          padding: 10px;
          width: 100%;
          background: #007bff;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
        "
      >
        Entrer
      </button>

      <p
        id="errorMsg"
        style="color: red; margin-top: 10px"
      ></p>
    </div>
  </div>
  <body class="bg-light">
    <div class="card p-4 shadow-sm mt-4">
      <h4 class="mb-3 text-primary">
        <i class="fa-brands fa-invision text-danger"></i>
        D√©tails des vendeurs ‚Äî Name / Status
      </h4>

      <!-- üîç Champ de recherche -->
      <div class="mb-3">
        <input
          type="text"
          id="searchVendeur"
          class="form-control"
          placeholder="Rechercher un vendeur..."
        />
      </div>

      <div class="table-responsive">
        <table
          id="sharedTableType"
          class="table table-striped table-bordered mt-3"
          style="width: 100%"
        >
          <thead class="table-dark">
            <tr>
              <th>Nom du vendeur</th>
              <th>Nombre des produits</th>
              <th>Statut</th>
              <th>Derni√®re connexion</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div
      class="containeer"
      style="zoom: 1.7"
    >
      <div class="menu-toggle">
        <span class="fa fa-plus"></span>
      </div>
      <div class="menu-round">
        <div
          class="btn-app"
          data-label="Dashboard"
        >
          <div class="fa">
            <a href="/dashboard"
              ><i
                class="fa-solid fa-circle-left"
                style="color: white"
              ></i>
            </a>
          </div>
        </div>
      </div>
    </div>
    <script src="js/main2.js"></script>
    <script>
      function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - new Date(date);
        const diffSec = Math.floor(diffMs / 1000);

        if (diffSec < 60) return `${diffSec} sec`; // ÿ£ŸÇŸÑ ŸÖŸÜ ÿØŸÇŸäŸÇÿ©
        const diffMin = Math.floor(diffSec / 60);
        if (diffMin < 60) return `${diffMin} min ${diffSec % 60} sec`; // ÿ£ŸÇŸÑ ŸÖŸÜ ÿ≥ÿßÿπÿ©
        const diffHrs = Math.floor(diffMin / 60);
        if (diffHrs < 24) return `${diffHrs} h ${diffMin % 60} min`; // ÿ£ŸÇŸÑ ŸÖŸÜ ŸäŸàŸÖ
        const diffDays = Math.floor(diffHrs / 24);
        if (diffDays < 7) return `${diffDays} jour${diffDays > 1 ? 's' : ''}`; // ÿ£ŸÇŸÑ ŸÖŸÜ ÿ£ÿ≥ÿ®Ÿàÿπ
        const diffWeeks = Math.floor(diffDays / 7);
        if (diffWeeks < 4) return `${diffWeeks} semaine${diffWeeks > 1 ? 's' : ''}`; // ÿ£ŸÇŸÑ ŸÖŸÜ ÿ¥Ÿáÿ±
        const diffMonths = Math.floor(diffDays / 30);
        if (diffMonths < 12) return `${diffMonths} mois`; // ÿ£ŸÇŸÑ ŸÖŸÜ ÿ≥ŸÜÿ©
        const diffYears = Math.floor(diffDays / 365);
        return `${diffYears} an${diffYears > 1 ? 's' : ''}`; // ÿ≥ŸÜÿ© ÿ£Ÿà ÿ£ŸÉÿ´ÿ±
      }

      async function loadPagePasswords() {
        try {
          const res = await fetch('/api/inventaireProo');
          const vendeurs = await res.json();

          // üîπ R√©cup√©rer le dernier createdAt pour chaque vendeur
          const latestBySeller = new Map();

          vendeurs.forEach((item) => {
            const seller = item.nameVendeur;
            const time = new Date(item.createdAt);

            if (!latestBySeller.has(seller) || time > latestBySeller.get(seller).time) {
              latestBySeller.set(seller, { seller, time });
            }
          });

          const filtered = Array.from(latestBySeller.values());
          const now = new Date();

          // üîπ Compter le nombre des produits par vendeur
          const sellerCount = {};

          vendeurs.forEach((item) => {
            const seller = item.nameVendeur;
            sellerCount[seller] = (sellerCount[seller] || 0) + 1;
          });

          // üîπ Calculer les informations
          filtered.forEach((s) => {
            s.totalProducts = sellerCount[s.seller];

            const last = new Date(s.time);
            const diffMs = now - last;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);

            if (diffSec <= 30) {
              s.status = 'En ligne';
              s.color = 'green';
            } else if (diffMin >= 10) {
              s.status = 'Hors ligne';
              s.color = 'red';
            } else {
              s.status = 'Actif r√©cemment';
              s.color = 'orange';
            }

            filtered.forEach((s) => {
              s.totalProducts = sellerCount[s.seller];

              // ÿ≠ÿ≥ÿßÿ® ÿ¢ÿÆÿ± ÿßÿ™ÿµÿßŸÑ
              s.timeAgo = formatTimeAgo(s.time);

              // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≠ÿßŸÑÿ©
              const diffSec = Math.floor((new Date() - new Date(s.time)) / 1000);
              const diffMin = Math.floor(diffSec / 60);

              if (diffSec <= 30) {
                s.status = 'En ligne';
                s.color = 'green';
              } else if (diffMin >= 10) {
                s.status = 'Hors ligne';
                s.color = 'red';
              } else {
                s.status = 'Actif r√©cemment';
                s.color = 'orange';
              }
            });
          });

          // üü¶ Remplir le tableau
          const tbody = document.querySelector('#sharedTableType tbody');
          tbody.innerHTML = filtered
            .map(
              (r) => `
            <tr>
              <td>${r.seller}</td>
              <td>${r.totalProducts}</td>

              <td>
                <span style="
                    display:inline-flex;
                    align-items:center;
                    gap:6px;
                ">
                  <span style="
                      width:12px;
                      height:12px;
                      border-radius:50%;
                      background:${r.color};
                      display:inline-block;
                  "></span>
                  ${r.status}
                </span>
              </td>

              <td>${r.timeAgo}</td>
            </tr>`
            )
            .join('');

          // üîπ Reconstruire DataTable
          if ($.fn.dataTable.isDataTable('#sharedTableType')) {
            $('#sharedTableType').DataTable().clear().destroy();
          }

          const table = $('#sharedTableType').DataTable({
            pageLength: 5,
            responsive: true,
            lengthMenu: [5, 10, 25, 50],
            language: {
              url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json',
            },
            columnDefs: [{ targets: '_all', className: 'text-center' }],
            dom: 'Bflrtip',
            buttons: [
              {
                extend: 'print',
                text: '<i class="fa fa-print"></i> Imprimer',
                className: 'btn btn-secondary btn-sm',
              },
            ],
            pagingType: 'full_numbers',
          });

          // üîç Recherche partielle par vendeur
          document.querySelector('#searchVendeur').addEventListener('keyup', function () {
            table.search(this.value).draw();
          });
        } catch (error) {
          console.error('‚ùå Erreur lors du chargement:', error);
        }
      }

      loadPagePasswords();
    </script>
  </body>
</html>
