<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Price Tag A6 - Optimized</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

        <style>
            @import url("https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap");
            /* التنسيقات (بقيت كما هي مع تعديلات طفيفة للطباعة) */
            @page {
                size: 105mm 148mm;
                margin: 0;
            }
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                background: #f3f1f1fa;
                padding: 20px;
                font-family: "Ubuntu", sans-serif;
                margin: 0;
            }
            .actions {
                background: #333;
                width: 100%;
                height: 70px;
                display: flex;
                justify-content: center;
                gap: 20px;
                align-items: center;
                position: fixed;
                top: 0;
                z-index: 9999;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            }
            button {
                padding: 10px 20px;
                border: none;
                background: #4a90e2;
                color: #fff;
                font-weight: bold;
                border-radius: 5px;
                cursor: pointer;
            }
            button#downloadAll {
                background: #e74c3c;
            }
            .card {
                width: 105mm;
                height: 148mm;
                background: #fff;
                position: relative;
                overflow: hidden;
                margin-top: 100px;
                border: 1px solid #ddd;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                flex-shrink: 0;
            }
            .title {
                position: absolute;
                top: 6mm;
                left: 6mm;
                right: 6mm;
                font-weight: 800;
                font-size: 17pt;
                color: #000;
                height: 40px;
                line-height: 2rem;
                letter-spacing: 1px;
                width: 80%;
            }
            .arc {
                position: absolute;
                left: 0;
                right: 0;
                top: 25mm;
                height: 35mm;
                z-index: 1;
                display: block;
            }
            .price {
                position: relative;
                right: 25px;
                top: 57mm;
                text-align: center;
                font-weight: 900;
                letter-spacing: 3px;
                color: #a82d29;
                z-index: 2;
            }
            .price .amount {
                font-size: 135px;
            }
            .price .unit {
                position: absolute;
                font-size: 25pt;
                vertical-align: top;
                padding: 10px;
                margin-top: 15px;
            }
            .price #cente {
                position: absolute;
                bottom: 0;
                margin-bottom: 20px;
                font-size: 30pt;
                vertical-align: bottom;
            }
            .small-box {
                position: absolute;
                left: 6mm;
                bottom: 12mm;
                width: 35mm;
                height: 30mm;
                border: 1px solid #6e5f52;
            }
            .meta {
                position: absolute;
                right: 6mm;
                bottom: 12mm;
                font-size: 10pt;
                font-weight: 800;
            }
            .meta input {
                border: none;
                padding: 2px;
                width: 120px;
                font-size: 10pt;
                font-weight: 900;
                outline: none;
            }
            .date {
                position: absolute;
                bottom: 5mm;
                left: 6mm;
                font-size: 8pt;
                color: #999;
            }
            .remove-btn {
                position: absolute;
                top: 5px;
                right: 5px;
                background: red;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                z-index: 10;
            }
            @media print {
                .actions,
                .remove-btn {
                    display: none;
                }
            }
        </style>
    </head>

    <body>
        <div class="actions">
            <button id="addCardBtn">
                <i class="bi bi-plus-circle"></i> Ajouter une Affiche
            </button>
            <button id="downloadAll">
                <i class="bi bi-file-earmark-pdf-fill"></i> Télécharger le PDF</button
            ><button id="clearStorage" style="background: #777">
                <i class="bi bi-trash"></i> Effacer la mémoire
            </button>
        </div>

        <div id="cardsContainer"></div>

        <script>
            const container = document.getElementById("cardsContainer");

            // 1. وظيفة حفظ البيانات في LocalStorage
            function saveToLocal() {
                const cardsData = [];
                document.querySelectorAll(".card").forEach(card => {
                    // نأخذ innerText لتجاهل الـ <span> والحصول على الرقم فقط (مثل 139,90)
                    let rawPrice = card.querySelector(".amount").innerText;

                    cardsData.push({
                        title: card.querySelector(".title").textContent,
                        amount: rawPrice.replace(",", ".").trim(), // نحول الفاصلة لنقطة للتخزين البرمجي
                        ref: card.querySelector(".Ref").value,
                        sku: card.querySelector(".sku").textContent,
                        date: card.querySelector(".date").textContent
                    });
                });
                localStorage.setItem("saved_cards", JSON.stringify(cardsData));
            }

            // 2. وظيفة استعادة البيانات
            function loadFromLocal() {
                const data = JSON.parse(
                    localStorage.getItem("saved_cards") || "[]"
                );
                if (data.length === 0) {
                    addCard(); // إضافة بطاقة فارغة إذا كانت الذاكرة فارغة
                } else {
                    data.forEach(item => addCard(item));
                }
            }

            // 3. وظيفة إضافة بطاقة (إنشاء الـ DOM)
            function addCard(data = null) {
                const card = document.createElement("div");
                card.className = "card";

                // نستخدم الدالة لتنسيق المبلغ سواء كان قادماً من الـ API أو الـ LocalStorage
                const displayAmount = data ? formatPrice(data.amount) : "0";

                card.innerHTML = `
        <div class="remove-btn">X</div>
        <div class="title" contenteditable="true">${
            data ? data.title : ""
        }</div>
        <div class="arc">
            <svg viewBox="0 0 1000 300" preserveAspectRatio="none" style="width: 100%; height: 100%">
                <path d="M0,200 C200,60 800,60 1000,200 L1000,300 L0,300 Z" fill="#fff"/>
                <path d="M0,210 C200,80 800,80 1000,210" stroke="#a82d29" stroke-width="60" fill="none" />
            </svg>
        </div>
        <div class="price">
            <span class="amount" contenteditable="true">${displayAmount}</span>
            <span class="unit"> Dh</span>
        </div>
        <div class="small-box"></div>
        <div class="meta">
            <div>Réf : <input type="number" class="Ref" value="${
                data ? data.ref : ""
            }" placeholder="GenCode.."></div>
            <div style="margin-top:10px">SKU : <span class="sku">${
                data ? data.sku : ""
            }</span></div>
        </div>
        <div class="date">${data ? data.date : getFormattedDate()}</div>
    `;

                // --- أحداث الحفظ التلقائي ---

                // عند الكتابة في أي مكان داخل الكارد
                card.addEventListener("input", () => {
                    saveToLocal();
                });

                // عند خروج المؤشر من حقل السعر (blur)، نعيد تنسيقه فوراً لضمان الشكل الصحيح
                const amountSpan = card.querySelector(".amount");
                amountSpan.addEventListener("blur", () => {
                    amountSpan.innerHTML = formatPrice(amountSpan.innerText);
                    saveToLocal();
                });

                card.querySelector(".remove-btn").onclick = () => {
                    card.remove();
                    saveToLocal();
                };

                const refInput = card.querySelector(".Ref");
                refInput.addEventListener("change", () =>
                    fetchPriceDynamic(card, refInput)
                );

                container.appendChild(card);
            }

            // 4. معالجة الـ SVG المعقدة (التحويل لـ Image يضمن ظهورها في الـ PDF)
            async function prepareSvg(cardElement) {
                const svg = cardElement.querySelector("svg");
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                const svgData = new XMLSerializer().serializeToString(svg);
                const img = new Image();

                // ضبط أبعاد الكانفس بناءً على أبعاد الـ SVG في الصفحة
                canvas.width = svg.clientWidth * 2;
                canvas.height = svg.clientHeight * 2;

                const svgBlob = new Blob([svgData], {
                    type: "image/svg+xml;charset=utf-8"
                });
                const url = URL.createObjectURL(svgBlob);

                await new Promise(resolve => {
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const pngUrl = canvas.toDataURL("image/png");
                        const newImg = document.createElement("img");
                        newImg.src = pngUrl;
                        newImg.style.width = "100%";
                        newImg.style.height = "100%";
                        svg.replaceWith(newImg);
                        URL.revokeObjectURL(url);
                        resolve();
                    };
                    img.src = url;
                });
            }

            // 5. تحميل الـ PDF
            document
                .getElementById("downloadAll")
                .addEventListener("click", async () => {
                    const { jsPDF } = window.jspdf;
                    const cards = document.querySelectorAll(".card");

                    // إنشاء PDF بمقاس A4
                    const pdf = new jsPDF("p", "mm", "a4");

                    // مقاسات البطاقة بالمليمتر (A7)
                    const cardWidth = 105;
                    const cardHeight = 148;

                    for (let i = 0; i < cards.length; i++) {
                        // إنشاء نسخة للرندر
                        const clone = cards[i].cloneNode(true);

                        // تنظيف النسخة من زر الحذف
                        const removeBtn = clone.querySelector(".remove-btn");
                        clone.querySelector(".arc").style.display = "none";
                        if (removeBtn) removeBtn.remove();

                        Object.assign(clone.style, {
                            position: "fixed",
                            left: "-10000px",
                            top: "0",
                            width: "105mm",
                            height: "148mm",
                            display: "block"
                        });
                        document.body.appendChild(clone);

                        // معالجة الـ SVG (تأكد أن هذه الدالة موجودة في كودك)
                        await prepareSvg(clone);

                        // التقاط الصورة بدقة عالية
                        const canvas = await html2canvas(clone, {
                            scale: 3,
                            useCORS: true,
                            backgroundColor: "#ffffff"
                        });

                        const imgData = canvas.toDataURL("image/jpeg", 1.0);

                        // نضع الإحداثيات 0 و 0 لوضعها في الزاوية اليسرى العليا تماماً
                        pdf.addImage(
                            imgData,
                            "JPEG",
                            0, // الإحداثي الأفقي (اليسار)
                            0, // الإحداثي الرأسي (الأعلى)
                            cardWidth,
                            cardHeight
                        );

                        // إضافة صفحة جديدة لكل بطاقة (باستثناء الأخيرة)
                        if (i < cards.length - 1) {
                            pdf.addPage("a4", "p");
                        }

                        document.body.removeChild(clone);
                    }

                    pdf.save("étiquettes_A4_top_left.pdf");
                });
            // دوال مساعدة
            function getFormattedDate() {
                return new Date().toLocaleDateString("fr-FR");
            }

            /*--- دالة التنسيق الذكي ---*/
            function formatPrice(priceValue) {
                if (
                    priceValue === undefined ||
                    priceValue === null ||
                    priceValue === ""
                )
                    return "0";

                // تنظيف القيمة من أي رموز غير رقمية باستثناء النقطة والفاصلة
                let cleanValue = String(priceValue)
                    .replace(/[^\d.,]/g, "")
                    .replace(",", ".");
                let parts = cleanValue.split(".");

                let mainPart = parts[0] || "0";
                let centsPart = parts[1]
                    ? parts[1].padEnd(2, "0").substring(0, 2)
                    : "00";

                if (centsPart === "00") {
                    return mainPart;
                } else {
                    return `${mainPart}<span id="cente">,${centsPart}</span>`;
                }
            }

            /*--- تحديث دالة جلب البيانات ---*/
            function fetchPriceDynamic(card, input) {
                const code = input.value.trim();
                if (!code) return;

                fetch(`/api/produit/${code}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            card.querySelector(".title").textContent =
                                data.libelle.replace(/\[.*?\]/g, "");
                            card.querySelector(".sku").textContent = data.anpf;
                            // هنا التعديل الجوهري
                            card.querySelector(".amount").innerHTML =
                                formatPrice(data.prix);
                            saveToLocal();
                        }
                    });
            }

            /*  document.getElementById("addCardBtn").onclick = () => addCard();*/
            document
                .getElementById("addCardBtn")
                .addEventListener("click", () => {
                    addCard();
                    scrollToLastCard();
                });

            function scrollToLastCard() {
                const cards = document.querySelectorAll(".card");
                const lastCard = cards[cards.length - 1];

                lastCard.scrollIntoView({
                    behavior: "smooth"
                });
            }

            document.getElementById("clearStorage").onclick = () => {
                // عبارة تأكيد احترافية بالفرنسية (أو العربية)
                const confirmation = confirm(
                    "Êtes-vous sûr de vouloir supprimer toutes les étiquettes ? Cette action est irréversible."
                );

                // إذا ضغط المستخدم على "OK" يتم المسح
                if (confirmation) {
                    localStorage.clear();
                    location.reload();
                }
                // إذا ضغط على "Annuler" لا يحدث شيء
            };

            // عند فتح الصفحة
            window.onload = loadFromLocal;
        </script>
    </body>
</html>
