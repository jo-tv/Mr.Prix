<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1" />
    <title>Price Tag A7</title>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600;800&display=swap"
      rel="stylesheet" />

    <style>
      @page {
        size: 105mm 148mm; /* Ø¹Ø±Ø¶ 105mm ÙˆØ§Ø±ØªÙØ§Ø¹ 148mm */
        margin: 0; /* Ø¨Ø¯ÙˆÙ† Ù‡ÙˆØ§Ù…Ø´ */
      }

      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-around;
        background: #f3f1f1fa;
        padding: 20px;
        font-family: 'Montserrat', sans-serif;
      }

      .card {
        width: 105mm;
        height: 148mm;
        box-sizing: border-box;
        position: relative;
        background: #f5efe9;
        overflow: hidden;
        padding: 6mm;
        border: 1px solid #ccc;
      }

      .title {
        position: absolute;
        top: 6mm;
        left: 6mm;
        right: 6mm;
        font-weight: 800;
        font-size: 15pt;
        line-height: 1.5;
        letter-spacing: 1px;
        color: #6e5f52;
        width: 90%;
      }

      .arc {
        position: absolute;
        left: 0;
        right: 0;
        top: 22mm;
        height: 26mm;
      }

      .price {
        position: absolute;
        /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù€ left Ùˆ Ø§Ù„Ù€ transform (Ø§Ù„Ù„ØªØ§Ù† ÙƒØ§Ù†ØªØ§ Ù„Ù„ØªÙˆØ³ÙŠØ·) */
        /* left: 45%; */
        /* transform: translateX(-50%); */

        /* Ø§Ù„ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒØ§Ù…Ù„: */
        left: 0; /* ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
        right: 0; /* ÙŠÙ†ØªÙ‡ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙŠÙ…ÙŠÙ† */
        width: 100%; /* ÙŠÙ…ØªØ¯ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¹Ø±Ø¶ */
        text-align: center; /* ÙŠØªÙˆØ³Ø· Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ */

        top: 48mm;
        font-weight: 900;
        font-size: 84pt; /* ØªÙ… ØªÙ‚Ù„ÙŠÙ„Ù‡ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø·Ø¹ */
        color: rgba(138, 76, 72, 0.9);
      }
      .price .unit {
        /* Ù„Ø¶Ù…Ø§Ù† Ù…ÙˆØ¶Ø¹Ù‡Ø§ Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø±Ù‚Ù… Ù…Ø¨Ø§Ø´Ø±Ø© */
        position: absolute;
        /* Ø­Ø¬Ù… Ø®Ø· Ø£ØµØºØ± Ù„Ù„ÙˆØ­Ø¯Ø© (22pt Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ 84pt Ù„Ù„Ø±Ù‚Ù…) */
        font-size: 25pt;
        font-weight: 600;
        /* ÙŠØ±ÙØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙÙˆÙ‚ Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ */
        vertical-align: bottom;
        /* Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        margin-left: -50px !important;
        /* ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± */
        top: 0 !important;
      }
      .price #cente {
        /* Ù„Ø¶Ù…Ø§Ù† Ù…ÙˆØ¶Ø¹Ù‡Ø§ Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø±Ù‚Ù… Ù…Ø¨Ø§Ø´Ø±Ø© */
        position: relative;
        /* Ø­Ø¬Ù… Ø®Ø· Ø£ØµØºØ± Ù„Ù„ÙˆØ­Ø¯Ø© (22pt Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ 84pt Ù„Ù„Ø±Ù‚Ù…) */
        font-size: 32pt;
        font-weight: 600;
        /* ÙŠØ±ÙØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙÙˆÙ‚ Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ */
        vertical-align: bottom;
        /* Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        margin-rigth: -20px !important;
        /* ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± */
        top: 0 !important;
      }

      .small-box {
        position: absolute;
        left: 6mm;
        bottom: 12mm;
        width: 45mm;
        height: 42mm;
        border: 0.6pt solid rgba(110, 95, 82, 0.6);
      }

      .meta {
        position: absolute;
        right: 5mm;
        bottom: 12mm;
        text-align: left;
        font-size: 9pt;
        color: #000;
        line-height: 2;
        font-weight: 900;
        letter-spacing: 1px;
      }

      .meta span {
        border: none;
        background: transparent;
        width: 15mm;
        font-size: 9pt;
        text-align: right;
        outline: none;
      }
      .meta input {
        border: none;
        background: transparent;
        width: 33mm;
        outline: none;
        letter-spacing: 1px;
        font-weight: 900;
        color: #000;
      }
      .date {
        font-size: 10px;
        opacity: 0.4;
        letter-spacing: 1px;
        font-weight: 700;
        position: absolute;
        bottom: 10px;
        left: 20px;
      }

      /* Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
      .actions {
        text-align: center;
        margin-bottom: 100px;
      }
      button {
        padding: 8px 16px;
        border: none;
        background: #c73f3a;
        color: #fff;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background: #a82d29;
      }
    </style>
  </head>

  <body>
    <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
    <div class="actions">
      <button id="addCardBtn">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø©</button>
      <button id="downloadAll">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª PDF</button>
    </div>
    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
    <div id="cardsContainer">
      <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø§Ù„Ù‚Ø§Ù„Ø¨) -->
      <div class="card card-template">
        <div
          class="title"
          contenteditable="false"></div>

        <!-- Ù‚ÙˆØ³ -->
        <div
          class="arc"
          aria-hidden="true">
          <svg
            viewBox="0 0 1000 300"
            preserveAspectRatio="none"
            width="100%"
            height="100%">
            <path
              d="M0,200 C200,60 800,60 1000,200 L1000,300 L0,300 Z"
              fill="#f5efe9" />
            <path
              d="M0,210 C200,80 800,80 1000,210"
              stroke="#c73f3a"
              stroke-width="40"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </div>

        <div class="price">
          <span
            class="amount"
            contenteditable="true"
            >1290<span id="cente">,00</span></span
          >
          <span class="unit">Dh</span>
        </div>

        <div class="small-box"></div>

        <div class="meta">
          <div>
            RÃ©f :
            <input
              type="number"
              class="Ref"
              placeholder="2000002244479" />
          </div>
          <div style="margin-top: 7px">
            SKU :
            <span
              contenteditable="false"
              class="sku">
            </span>
          </div>
        </div>
        <div class="date"></div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      /*-------------------------------*/
      /*   ØªØ­ÙˆÙŠÙ„ SVG â†’ ØµÙˆØ±Ø©           */
      /*-------------------------------*/
      function svgToImg(card) {
        const svg = card.querySelector('.arc svg');
        if (!svg) return;

        const svgData = new XMLSerializer().serializeToString(svg);
        const svgBlob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);

        const img = document.createElement('img');
        img.src = url;
        img.style.width = svg.getAttribute('width') || '100%';
        img.style.height = svg.getAttribute('height') || '100%';

        svg.parentNode.replaceChild(img, svg);
      }

      /*-------------------------------*/
      /* Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± API         */
      /*-------------------------------*/
      function fetchPriceDynamic(card, input) {
        const code = input.value.trim();

        const title = card.querySelector('.title');
        const sku = card.querySelector('.sku');
        const price = card.querySelector('.amount');

        if (!code) {
          title.textContent = '';
          sku.textContent = '';
          price.textContent = '0,00';
          return;
        }

        fetch(`/api/produit/${code}`)
          .then((res) => (res.ok ? res.json() : null))
          .then((data) => {
            if (!data) {
              title.textContent = '';
              sku.textContent = '';
              price.textContent = '0,00';
              return;
            }

            title.textContent = data.libelle.replace(/\[.*?\]/g, '').trim();
            sku.textContent = data.anpf;
            price.innerHTML = `${data.prix}<span id="cente">,00</span>`;
          })
          .catch((err) => console.error('API Error:', err));
      }

      /*-------------------------------*/
      /*  Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©        */
      /*-------------------------------*/
      document.getElementById('addCardBtn').addEventListener('click', () => {
        const template = document.querySelector('.card-template');
        const newCard = template.cloneNode(true);

        newCard.classList.remove('card-template');
        newCard.classList.add('card');

        newCard.querySelector('.title').textContent = '';
        newCard.querySelector('.sku').textContent = '';
        newCard.querySelector('.amount').textContent = '0,00';
        newCard.querySelector('.Ref').value = '';
        newCard.querySelector('.date').textContent = getFormattedDate();

        // Ø±Ø¨Ø· Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ù€ API
        const refInput = newCard.querySelector('.Ref');
        refInput.addEventListener('input', () => fetchPriceDynamic(newCard, refInput));

        document.getElementById('cardsContainer').appendChild(newCard);
      });

      /*-------------------------------*/
      /*   ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª PDF    */
      /*-------------------------------*/
      document.getElementById('downloadAll').addEventListener('click', async () => {
        const { jsPDF } = window.jspdf; // ØªØ­Ù…ÙŠÙ„ jsPDF Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­

        const cards = document.querySelectorAll('.card:not(.card-template)');
        if (!cards.length) return;

        const pdf = new jsPDF({
          unit: 'mm',
          format: [105, 148],
          orientation: 'portrait',
        });

        for (let i = 0; i < cards.length; i++) {
          svgToImg(cards[i]);

          const canvas = await html2canvas(cards[i], { scale: 4 });
          const imgData = canvas.toDataURL('image/jpeg', 1);

          if (i > 0) pdf.addPage();
          pdf.addImage(imgData, 'JPEG', 0, 0, 105, 148);
        }

        pdf.save('cards_' + getFormattedDate() + '.pdf');
      });

      /*-------------------------------*/
      /*   Ø§Ù„ØªØ§Ø±ÙŠØ®                     */
      /*-------------------------------*/
      function getFormattedDate() {
        const d = new Date();
        return (
          String(d.getDate()).padStart(2, '0') +
          '/' +
          String(d.getMonth() + 1).padStart(2, '0') +
          '/' +
          d.getFullYear()
        );
      }

      document.querySelector('.date').textContent = getFormattedDate();
    </script>
    <script>
  /*-------------------------------*/
  /* ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©         */
  /*-------------------------------*/
  window.addEventListener("DOMContentLoaded", () => {
    const original = document.querySelector(".card-template");

    if (original) {
      // Ø¶Ø¨Ø· Ø§Ù„ØªØ§Ø±ÙŠØ®
      original.querySelector(".date").textContent = getFormattedDate();

      // Ø±Ø¨Ø· Ø­Ù‚Ù„ RÃ©f Ø¨Ø§Ù„Ù€ API
      const refInput = original.querySelector(".Ref");
      refInput.addEventListener("input", () => {
        fetchPriceDynamic(original, refInput);
      });
    }
  });
</script>
  </body>
</html>
