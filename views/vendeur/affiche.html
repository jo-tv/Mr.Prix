<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1" />
    <title>Price Tag A7</title>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <!-- Ø®Ø· -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600;800&display=swap"
      rel="stylesheet" />
    <style>
      @page {
        size: 105mm 148mm; /* Ø¹Ø±Ø¶ 105mm ÙˆØ§Ø±ØªÙØ§Ø¹ 148mm */
        margin: 0; /* Ø¨Ø¯ÙˆÙ† Ù‡ÙˆØ§Ù…Ø´ */
      }

      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-around;
        background: #f3f1f1fa;
        padding: 20px;
        font-family: 'Montserrat', sans-serif;
      }

      .card {
        width: 105mm;
        height: 148mm;
        box-sizing: border-box;
        position: relative;
        background: #f5efe9;
        overflow: hidden;
        padding: 6mm;
        border: 1px solid #ccc;
      }

      .title {
        position: absolute;
        top: 6mm;
        left: 6mm;
        right: 6mm;
        font-weight: 800;
        font-size: 15pt;
        line-height: 1.5;
        letter-spacing: 1px;
        color: #6e5f52;
        width: 90%;
      }

      .arc {
        position: absolute;
        left: 0;
        right: 0;
        top: 22mm;
        height: 26mm;
      }

      .price {
        position: absolute;
        /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù€ left Ùˆ Ø§Ù„Ù€ transform (Ø§Ù„Ù„ØªØ§Ù† ÙƒØ§Ù†ØªØ§ Ù„Ù„ØªÙˆØ³ÙŠØ·) */
        /* left: 45%; */
        /* transform: translateX(-50%); */

        /* Ø§Ù„ØªÙˆØ³ÙŠØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒØ§Ù…Ù„: */
        left: 0; /* ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
        right: 0; /* ÙŠÙ†ØªÙ‡ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙŠÙ…ÙŠÙ† */
        width: 100%; /* ÙŠÙ…ØªØ¯ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¹Ø±Ø¶ */
        text-align: center; /* ÙŠØªÙˆØ³Ø· Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ */

        top: 48mm;
        font-weight: 900;
        font-size: 84pt; /* ØªÙ… ØªÙ‚Ù„ÙŠÙ„Ù‡ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø·Ø¹ */
        color: rgba(138, 76, 72, 0.9);
      }
      .price .unit {
        /* Ù„Ø¶Ù…Ø§Ù† Ù…ÙˆØ¶Ø¹Ù‡Ø§ Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø±Ù‚Ù… Ù…Ø¨Ø§Ø´Ø±Ø© */
        position: relative;
        /* Ø­Ø¬Ù… Ø®Ø· Ø£ØµØºØ± Ù„Ù„ÙˆØ­Ø¯Ø© (22pt Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ 84pt Ù„Ù„Ø±Ù‚Ù…) */
        font-size: 22pt;
        font-weight: 600;
        /* ÙŠØ±ÙØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙÙˆÙ‚ Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ */
        vertical-align: bottom;
        /* Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        margin-left: -20px;
        /* ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± */
        top: -0.3em;
      }

      .small-box {
        position: absolute;
        left: 6mm;
        bottom: 12mm;
        width: 40mm;
        height: 38mm;
        border: 0.6pt solid rgba(110, 95, 82, 0.6);
      }

      .meta {
        position: absolute;
        right: 5mm;
        bottom: 12mm;
        text-align: left;
        font-size: 9pt;
        color: #000;
        line-height: 2;
        font-weight: 900;
        letter-spacing: 1px;
      }

      .meta span {
        border: none;
        background: transparent;
        width: 15mm;
        font-size: 9pt;
        text-align: right;
        outline: none;
      }
      .meta input {
        border: none;
        background: transparent;
        width: 33mm;
        outline: none;
        letter-spacing: 1px;
        font-weight: 900;
        color: #000;
      }
      .date {
        font-size: 10px;
        opacity: 0.4;
        letter-spacing: 1px;
        font-weight: 700;
        position: absolute;
        bottom: 10px;
        left: 10px;
      }

      /* Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
      .actions {
        text-align: center;
        margin-bottom: 100px;
      }
      button {
        padding: 8px 16px;
        border: none;
        background: #c73f3a;
        color: #fff;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        background: #a82d29;
      }
    </style>
  </head>
  <body>
    <div class="actions">
      <button onclick="downloadPDF()">ğŸ“¥ TÃ©lÃ©charger PDF</button>
    </div>
    <div
      class="card"
      id="cardContent">
      <div
        class="title"
        contenteditable="false"></div>

      <!-- Ù‚ÙˆØ³ -->
      <div
        class="arc"
        aria-hidden="true">
        <svg
          viewBox="0 0 1000 300"
          preserveAspectRatio="none"
          width="100%"
          height="100%">
          <path
            d="M0,200 C200,60 800,60 1000,200 L1000,300 L0,300 Z"
            fill="#f5efe9" />
          <path
            d="M0,210 C200,80 800,80 1000,210"
            stroke="#c73f3a"
            stroke-width="40"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </div>

      <div class="price">
        <span
          class="amount"
          contenteditable="true"
          >1290</span
        >
        <span
          class="unit"
          contenteditable="true"
          >Dh</span
        >
      </div>

      <div class="small-box"></div>

      <div class="meta">
        <div>
          RÃ©f :
          <input
            type="number"
            class="Ref"
            placeholder="2000002244479" />
        </div>
        <div style="margin-top: 7px">
          SKU :
          <span
            contenteditable="false"
            class="sku">
          </span>
        </div>
      </div>
      <div class="date"></div>
    </div>
    <script>
      function svgToImg(selector) {
        const svg = document.querySelector(selector); // âœ… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ±
        if (!svg) return;

        const svgData = new XMLSerializer().serializeToString(svg);
        const svgBlob = new Blob([svgData], {
          type: 'image/svg+xml;charset=utf-8',
        });
        const url = URL.createObjectURL(svgBlob);

        // Ù†Ù†Ø´Ø¦ ØµÙˆØ±Ø© Ù…ÙƒØ§Ù† Ø§Ù„Ù€ svg
        const img = document.createElement('img');
        img.src = url;
        img.style.width = svg.getAttribute('width') || '100%';
        img.style.height = svg.getAttribute('height') || '100%';

        svg.parentNode.replaceChild(img, svg);
      }

      function downloadPDF() {
        // Ù†Ø­ÙˆÙ„ Ø§Ù„Ù€ SVG Ø¯Ø§Ø®Ù„ .arc Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
        svgToImg('.arc svg');

        const element = document.getElementById('cardContent');

        const opt = {
          margin: 0,
          filename: 'affi_a7|' + getFormattedDate() + '.pdf',
          image: { type: 'jpeg', quality: 1 },
          html2canvas: {
            // ÙŠÙØ¶Ù„ Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³ 4 Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø§Ù„ÙŠØ©
            scale: 4,
            useCORS: true,
          },
          jsPDF: {
            unit: 'mm',
            // Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„ÙˆØ±Ù‚Ø© A6: 105 Ù…Ù„Ù… Ø¹Ø±Ø¶ØŒ 148 Ù…Ù„Ù… Ø§Ø±ØªÙØ§Ø¹
            format: [105, 148],
            orientation: 'portrait',
          },
        };

        // Ù†Ø³ØªØ®Ø¯Ù… delay Ø¨Ø³ÙŠØ· Ø­ØªÙ‰ ØªØ­Ù…Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØ±
        setTimeout(() => {
          html2pdf().set(opt).from(element).save();
        }, 500);
      }
      // Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ â†’ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      const input = document.querySelector('.Ref');
      const title = document.querySelector('.title');
      const anpf = document.querySelector('.sku');
      const price = document.querySelector('.amount');
      async function fetchPrice(input) {
        const code = input.value.trim();
        if (!code) {
          anpf.value = '';
          return;
        }

        try {
          const response = await fetch(`/api/produit/${code}`);
          if (!response.ok) {
            title.textContent = '';
            anpf.textContent = '';
            price.textContent = '';
            return;
          }

          const data = await response.json();
          console.log(data);

          title.textContent = data.libelle.replace(/\[.*?\]/g, '').trim();
          anpf.textContent = data.anpf;
          price.textContent = data.prix;
        } catch (err) {
          console.error(err);
          anpf.value = '';
        }
      }
      input.addEventListener('input', function () {
        fetchPrice(input);
      });
      // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
      function getFormattedDate() {
        const today = new Date();

        const day = String(today.getDate()).padStart(2, '0'); // 25
        const month = String(today.getMonth() + 1).padStart(2, '0'); // 08 (Ø§Ù„Ø£Ø´Ù‡Ø± ØªØ¨Ø¯Ø£ Ù…Ù† 0)
        const year = today.getFullYear(); // 2025

        return `${day}/${month}/${year}`;
      }
      document.querySelector('.date').textContent = getFormattedDate();
    </script>
  </body>
</html>
