<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Price Tag A7 - Optimized</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600;800&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

        <style>
            /* التنسيقات (بقيت كما هي مع تعديلات طفيفة للطباعة) */
            @page {
                size: 105mm 148mm;
                margin: 0;
            }
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                background: #f3f1f1fa;
                padding: 20px;
                font-family: "Montserrat", sans-serif;
                margin: 0;
            }
            .actions {
                background: #333;
                width: 100%;
                height: 70px;
                display: flex;
                justify-content: center;
                gap: 20px;
                align-items: center;
                position: fixed;
                top: 0;
                z-index: 9999;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            }
            button {
                padding: 10px 20px;
                border: none;
                background: #4a90e2;
                color: #fff;
                font-weight: bold;
                border-radius: 5px;
                cursor: pointer;
            }
            button#downloadAll {
                background: #e74c3c;
            }
            .card {
                width: 105mm;
                height: 148mm;
                background: #fff;
                position: relative;
                overflow: hidden;
                margin-top: 100px;
                border: 1px solid #ddd;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                flex-shrink: 0;
            }
            .title {
                position: absolute;
                top: 10mm;
                left: 6mm;
                right: 6mm;
                font-weight: 800;
                font-size: 16pt;
                color: #6e5f52;
                height: 40px;
            }
            .arc {
                position: absolute;
                left: 0;
                right: 0;
                top: 25mm;
                height: 35mm;
                z-index: 1;
            }
            .price {
                position: absolute;
                left: 0;
                right: 0;
                top: 52mm;
                text-align: center;
                font-weight: 900;
                font-size: 80pt;
                color: #a82d29;
                z-index: 2;
            }
            .price .unit {
                font-size: 25pt;
                margin-left: 5px;
            }
            .price #cente {
                font-size: 35pt;
                vertical-align: super;
            }
            .small-box {
                position: absolute;
                left: 6mm;
                bottom: 12mm;
                width: 45mm;
                height: 40mm;
                border: 1px solid #6e5f52;
            }
            .meta {
                position: absolute;
                right: 6mm;
                bottom: 12mm;
                font-size: 10pt;
                font-weight: 800;
            }
            .meta input {
                border: 1px solid #eee;
                padding: 2px;
                width: 120px;
                font-size: 10pt;
                font-weight: 900;
            }
            .date {
                position: absolute;
                bottom: 5mm;
                left: 6mm;
                font-size: 8pt;
                color: #999;
            }
            .remove-btn {
                position: absolute;
                top: 5px;
                right: 5px;
                background: red;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                z-index: 10;
            }
            @media print {
                .actions,
                .remove-btn {
                    display: none;
                }
            }
        </style>
    </head>

    <body>
        <div class="actions">
            <button id="addCardBtn">
                <i class="bi bi-plus-circle"></i> إضافة بطاقة
            </button>
            <button id="downloadAll">
                <i class="bi bi-file-earmark-pdf-fill"></i> تحميل PDF
            </button>
            <button id="clearStorage" style="background: #777">
                مسح الذاكرة
            </button>
        </div>

        <div id="cardsContainer"></div>

        <script>
            const container = document.getElementById("cardsContainer");

            // 1. وظيفة حفظ البيانات في LocalStorage
            function saveToLocal() {
                const cardsData = [];
                document.querySelectorAll(".card").forEach(card => {
                    cardsData.push({
                        title: card.querySelector(".title").textContent,
                        amount: card.querySelector(".amount").childNodes[0]
                            .textContent,
                        ref: card.querySelector(".Ref").value,
                        sku: card.querySelector(".sku").textContent,
                        date: card.querySelector(".date").textContent
                    });
                });
                localStorage.setItem("saved_cards", JSON.stringify(cardsData));
            }

            // 2. وظيفة استعادة البيانات
            function loadFromLocal() {
                const data = JSON.parse(
                    localStorage.getItem("saved_cards") || "[]"
                );
                if (data.length === 0) {
                    addCard(); // إضافة بطاقة فارغة إذا كانت الذاكرة فارغة
                } else {
                    data.forEach(item => addCard(item));
                }
            }

            // 3. وظيفة إضافة بطاقة (إنشاء الـ DOM)
            function addCard(data = null) {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `
                <div class="remove-btn">X</div>
                <div class="title" contenteditable="true">${
                    data ? data.title : ""
                }</div>
                <div class="arc">
                    <svg viewBox="0 0 1000 300" preserveAspectRatio="none" style="width: 100%; height: 100%">
                        <path d="M0,200 C200,60 800,60 1000,200 L1000,300 L0,300 Z" fill="#fff"/>
                        <path d="M0,210 C200,80 800,80 1000,210" stroke="#c73f3a" stroke-width="60" fill="none" />
                    </svg>
                </div>
                <div class="price">
                    <span class="amount" contenteditable="true">
                        ${
                            data
                                ? formatPrice(data.amount)
                                : `0<span id="cente">,00</span>`
                        }
                    </span>
                    <span class="unit">Dh</span>
                </div>

                <div class="small-box"></div>
                <div class="meta">
                    <div>Réf : <input type="number" class="Ref" value="${
                        data ? data.ref : ""
                    }" placeholder="GenCode.."></div>
                    <div style="margin-top:10px">SKU : <span class="sku">${
                        data ? data.sku : ""
                    }</span></div>
                </div>
                <div class="date">${data ? data.date : getFormattedDate()}</div>
            `;

                // أحداث التغيير للحفظ التلقائي
                card.addEventListener("input", saveToLocal);
                card.querySelector(".remove-btn").onclick = () => {
                    card.remove();
                    saveToLocal();
                };

                const refInput = card.querySelector(".Ref");
                refInput.addEventListener("change", () =>
                    fetchPriceDynamic(card, refInput)
                );

                container.appendChild(card);
            }

            // 4. معالجة الـ SVG المعقدة (التحويل لـ Image يضمن ظهورها في الـ PDF)
            async function prepareSvg(cardElement) {
                const svg = cardElement.querySelector("svg");
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                const svgData = new XMLSerializer().serializeToString(svg);
                const img = new Image();

                // ضبط أبعاد الكانفس بناءً على أبعاد الـ SVG في الصفحة
                canvas.width = svg.clientWidth * 2;
                canvas.height = svg.clientHeight * 2;

                const svgBlob = new Blob([svgData], {
                    type: "image/svg+xml;charset=utf-8"
                });
                const url = URL.createObjectURL(svgBlob);

                await new Promise(resolve => {
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const pngUrl = canvas.toDataURL("image/png");
                        const newImg = document.createElement("img");
                        newImg.src = pngUrl;
                        newImg.style.width = "100%";
                        newImg.style.height = "100%";
                        svg.replaceWith(newImg);
                        URL.revokeObjectURL(url);
                        resolve();
                    };
                    img.src = url;
                });
            }

            // 5. تحميل الـ PDF
            document
                .getElementById("downloadAll")
                .addEventListener("click", async () => {
                    const { jsPDF } = window.jspdf;
                    const cards = document.querySelectorAll(".card");
                    const pdf = new jsPDF("p", "mm", "a4");

                    for (let i = 0; i < cards.length; i++) {
                        const clone = cards[i].cloneNode(true);
                        // إخفاء زر الحذف في النسخة
                        clone.querySelector(".remove-btn").remove();

                        Object.assign(clone.style, {
                            position: "fixed",
                            left: "-10000px",
                            top: "0",
                            width: "105mm",
                            height: "148mm"
                        });
                        document.body.appendChild(clone);

                        // حل مشكلة الـ SVG
                        await prepareSvg(clone);

                        const canvas = await html2canvas(clone, {
                            scale: 2,
                            useCORS: true
                        });
                        const imgData = canvas.toDataURL("image/jpeg", 1.0);

                        const x = (i % 2) * 105;
                        const y = (Math.floor(i / 2) % 2) * 148;

                        pdf.addImage(imgData, "JPEG", x, y, 105, 148);

                        if ((i + 1) % 4 === 0 && i + 1 < cards.length)
                            pdf.addPage();

                        document.body.removeChild(clone);
                    }
                    pdf.save("tags.pdf");
                });

            // دوال مساعدة
            function getFormattedDate() {
                return new Date().toLocaleDateString("fr-FR");
            }

            /*--- دالة التنسيق الذكي ---*/
            function formatPrice(priceValue) {
                if (!priceValue) return `0<span id="cente">,00</span>`;
                let priceStr = String(priceValue).replace(",", ".");
                let parts = priceStr.split(".");

                let mainPart = parts[0];
                let centsPart = parts[1]
                    ? parts[1].padEnd(2, "0").substring(0, 2)
                    : "00";

                return `${mainPart}<span id="cente">,${centsPart}</span>`;
            }

            /*--- تحديث دالة جلب البيانات ---*/
            function fetchPriceDynamic(card, input) {
                const code = input.value.trim();
                if (!code) return;

                fetch(`/api/produit/${code}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            card.querySelector(".title").textContent =
                                data.libelle.replace(/\[.*?\]/g, "");
                            card.querySelector(".sku").textContent = data.anpf;
                            // هنا التعديل الجوهري
                            card.querySelector(".amount").innerHTML =
                                formatPrice(data.prix);
                            saveToLocal();
                        }
                    });
            }

            document.getElementById("addCardBtn").onclick = () => addCard();
            document.getElementById("clearStorage").onclick = () => {
                localStorage.clear();
                location.reload();
            };

            // عند فتح الصفحة
            window.onload = loadFromLocal;
        </script>
    </body>
</html>
