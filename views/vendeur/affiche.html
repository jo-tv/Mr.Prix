<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1"
    />
    <title>Price Tag A7</title>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <!-- Ø®Ø· -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600;800&display=swap"
      rel="stylesheet"
    />
    <style>
      @page {
        size: 105mm 148mm; /* Ø¹Ø±Ø¶ 105mm ÙˆØ§Ø±ØªÙØ§Ø¹ 148mm */
        margin: 0; /* Ø¨Ø¯ÙˆÙ† Ù‡ÙˆØ§Ù…Ø´ */
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        background: #eee;
        padding: 20px;
        font-family: 'Montserrat', sans-serif;
      }

      .card {
        width: 74mm;
        height: 105mm;
        box-sizing: border-box;
        position: relative;
        background: #f5efe9;
        overflow: hidden;
        padding: 6mm;
        border: 1px solid #ccc;
      }

      .title {
        position: absolute;
        top: 6mm;
        left: 6mm;
        right: 6mm;
        font-weight: 800;
        font-size: 9pt;
        line-height: 2;
        color: #6e5f52;
      }

      .arc {
        position: absolute;
        left: 0;
        right: 0;
        top: 22mm;
        height: 26mm;
      }

      .price {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 48mm;
        font-weight: 800;
        font-size: 30pt;
        color: rgba(138, 76, 72, 0.9);
      }
      .price .unit {
        font-size: 10pt;
        font-weight: 600;
        vertical-align: super;
      }

      .small-box {
        position: absolute;
        left: 6mm;
        bottom: 12mm;
        width: 20mm;
        height: 18mm;
        border: 0.6pt solid rgba(110, 95, 82, 0.6);
      }

      .meta {
        position: absolute;
        right: 7mm;
        bottom: 12mm;
        text-align: left;
        font-size: 7pt;
        color: #6e5f52;
        line-height: 2;
        font-weight: 600;
        letter-spacing: 1px;
      }

      .meta span {
        border: none;
        background: transparent;
        width: 15mm;
        font-size: 7pt;
        text-align: right;
        outline: none;
      }
      .meta input {
        border: none;
        background: transparent;
        width: 22mm;
        font-size: 7pt;
        outline: none;
        letter-spacing: 1px;
      }
      .date {
        font-size: 10px;
        opacity: 0.4;
        letter-spacing: 1px;
        font-weight: 700;
        position: absolute;
        bottom: 10px;
        left: 10px;
      }

      /* Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
      .actions {
        margin-top: 20px;
        text-align: center;
        position: absolute;
        bottom: 150px;
      }
      button {
        padding: 8px 16px;
        border: none;
        background: #c73f3a;
        color: #fff;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
        zoom: 1.5;
      }
      button:hover {
        background: #a82d29;
      }
    </style>
  </head>
  <body>
    <div
      class="card"
      id="cardContent"
    >
      <div
        class="title"
        contenteditable="false"
      ></div>

      <!-- Ù‚ÙˆØ³ -->
      <div
        class="arc"
        aria-hidden="true"
      >
        <svg
          viewBox="0 0 1000 300"
          preserveAspectRatio="none"
          width="100%"
          height="100%"
        >
          <path
            d="M0,200 C200,60 800,60 1000,200 L1000,300 L0,300 Z"
            fill="#f5efe9"
          />
          <path
            d="M0,210 C200,80 800,80 1000,210"
            stroke="#c73f3a"
            stroke-width="40"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>

      <div class="price">
        <span
          class="amount"
          contenteditable="true"
        ></span>
        <span class="unit">Dh</span>
      </div>

      <div class="small-box"></div>

      <div class="meta">
        <div>
          RÃ©f :
          <input
            type="number"
            class="Ref"
            placeholder="2000002244479"
          />
        </div>
        <div style="margin-top: 7px">
          SKU :
          <span
            contenteditable="false"
            class="sku"
          >
          </span>
        </div>
      </div>
      <div class="date"></div>
    </div>
    <div class="actions">
      <button onclick="downloadPDF()">ğŸ“¥ TÃ©lÃ©charger PDF</button>
    </div>
    <script>
      function svgToImg(selector) {
        const svg = document.querySelector(selector); // âœ… Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ±
        if (!svg) return;

        const svgData = new XMLSerializer().serializeToString(svg);
        const svgBlob = new Blob([svgData], {
          type: 'image/svg+xml;charset=utf-8',
        });
        const url = URL.createObjectURL(svgBlob);

        // Ù†Ù†Ø´Ø¦ ØµÙˆØ±Ø© Ù…ÙƒØ§Ù† Ø§Ù„Ù€ svg
        const img = document.createElement('img');
        img.src = url;
        img.style.width = svg.getAttribute('width') || '100%';
        img.style.height = svg.getAttribute('height') || '100%';

        svg.parentNode.replaceChild(img, svg);
      }

      function downloadPDF() {
        // Ù†Ø­ÙˆÙ„ Ø§Ù„Ù€ SVG Ø¯Ø§Ø®Ù„ .arc Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
        svgToImg('.arc svg');

        const element = document.getElementById('cardContent');

        const opt = {
          margin: 0,
          filename: 'affi_a7|' + getFormattedDate() + '.pdf',
          image: { type: 'jpeg', quality: 1 },
          html2canvas: { scale: 3, useCORS: true },
          jsPDF: {
            unit: 'mm',
            format: [74, 105],
            orientation: 'portrait',
          },
        };

        // Ù†Ø³ØªØ®Ø¯Ù… delay Ø¨Ø³ÙŠØ· Ø­ØªÙ‰ ØªØ­Ù…Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØ±
        setTimeout(() => {
          html2pdf().set(opt).from(element).save();
        }, 500);
      }
      // Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ â†’ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      const input = document.querySelector('.Ref');
      const title = document.querySelector('.title');
      const anpf = document.querySelector('.sku');
      const price = document.querySelector('.amount');
      async function fetchPrice(input) {
        const code = input.value.trim();
        if (!code) {
          anpf.value = '';
          return;
        }

        try {
          const response = await fetch(`/api/produit/${code}`);
          if (!response.ok) {
            
            title.textContent = '';
            anpf.textContent = '';
            price.textContent = '';
            return;
          }

          const data = await response.json();
          console.log(data);

          title.textContent = data.libelle.replace(/\[.*?\]/g, '').trim();
          anpf.textContent = data.anpf;
          price.textContent = data.prix;
        } catch (err) {
          console.error(err);
          anpf.value = '';
        }
      }
      input.addEventListener('input', function () {
        fetchPrice(input);
      });
      // Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
      function getFormattedDate() {
        const today = new Date();

        const day = String(today.getDate()).padStart(2, '0'); // 25
        const month = String(today.getMonth() + 1).padStart(2, '0'); // 08 (Ø§Ù„Ø£Ø´Ù‡Ø± ØªØ¨Ø¯Ø£ Ù…Ù† 0)
        const year = today.getFullYear(); // 2025

        return `${day}/${month}/${year}`;
      }
      document.querySelector('.date').textContent = getFormattedDate();
    </script>
  </body>
</html>
