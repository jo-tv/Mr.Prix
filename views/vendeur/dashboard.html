<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Tableau de bord | Inventaire</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->

    <style>
      body {
        background: #f8f9fa;
      }

      .dashboard-header {
        margin-top: 20px;
      }

      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
      }

      .card i {
        font-size: 2rem;
      }

      .data-section {
        margin-top: 30px;
      }

      @media (max-width: 768px) {
        .card i {
          font-size: 1.5rem;
        }
      .chart {
        box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid p-4">
      <h2 class="text-center dashboard-header">
        <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        />
        <i class="fas fa-chart-line text-primary"></i> Tableau de bord
      </h2>

      <!-- Cards statistiques -->
      <div
        class="row text-center mt-4"
        id="stats-cards"
      >
        <div class="col-md-3 col-6 mb-3 usersCount">
          <div class="card text-bg-primary p-3">
            <i class="fas fa-users mb-2"></i>
            <h5>Utilisateurs</h5>
            <h3 id="usersCount">0</h3>
          </div>
        </div>

        <div class="col-md-3 col-6 mb-3">
          <div class="card text-bg-success p-3">
            <i class="fas fa-boxes-stacked mb-2"></i>
            <h5>Produits</h5>
            <h3 id="productsCount">0</h3>
          </div>
        </div>

        <div class="col-md-3 col-6 mb-3">
          <div class="card text-bg-warning p-3">
            <i class="fas fa-boxes-stacked mb-2"></i>
            <h5>N° Adress</h5>
            <h3 id="adressCount">0 / 700</h3>
          </div>
        </div>

        <div class="col-md-3 col-6 mb-3">
          <div class="card text-bg-info p-3">
            <i class="fas fa-coins mb-2"></i>
            <h5>Valeur Totale</h5>
            <h3 id="totalValue">0 DH</h3>
          </div>
        </div>

        <div class="col-md-3 col-6 mb-3">
          <div class="card text-bg-danger p-3">
            <i class="fas fa-map-marker-alt mb-2"></i>
            <h5>Adresses partagées</h5>
            <h3 id="sharedAddresses">0</h3>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="container-fluid my-5">
        <div class="card chart border-0 rounded-4">
          <div class="card-body">
            <h5 class="card-title text-center mb-4">
              <i class="fas fa-chart-bar text-primary"></i> Top 10 vendeurs par nombre de produits
            </h5>
            <div style="height: 400px; overflow-x: auto">
              <canvas
                id="vendeurChart"
                style="max-height: 400px; width: 100%"
              ></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="container-fluid my-5">
        <div class="card chart border-0 rounded-4">
          <div class="card-body">
            <h5 class="card-title text-center mb-4">
              <i class="fas fa-map-marker-alt text-success"></i>
              Statistiques des adresses utilisées
            </h5>
            <div style="height: 400px; overflow-x: auto">
              <canvas
                id="adressChart"
                style="max-height: 400px; width: 100%"
              ></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Tableau des adresses partagées -->
      <div class="data-section">
        <div class="card p-3">
          <h5 class="mb-3"><i class="fas fa-location-dot text-danger"></i> Adresses partagées</h5>
          <div class="table-responsive">
            <table
              id="sharedTable"
              class="table table-striped table-bordered"
              style="width: 100%"
            >
              <thead class="table-dark">
                <tr>
                  <th>Adresse</th>
                  <th>Vendeurs</th>
                  <th>N° Vendeurs</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- JS Libraries (ترتيب التحميل مهم) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- تأكّد من وجود هذه الـ canvases في HTML -->
    <!-- <canvas id="vendeurChart"></canvas> -->
    <!-- <canvas id="adressChart"></canvas> -->

    <script>
      /* === Helpers & Globals === */
      function escapeHtml(unsafe) {
        if (unsafe == null) return '';
        return String(unsafe)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      // حافظ على مراجع المخططات عالمياً لكي تتمكن من تدميرها قبل إعادة الرسم
      window._charts = window._charts || { vendeur: null, adress: null };

      /* === الدالة الأساسية لتحميل البيانات ورسم كل شيء === */
      async function initDashboard() {
        try {
          // جلب البيانات مرة واحدة
          const resp = await fetch('/api/inventairePro');
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const produits = await resp.json();

          // --- إحصائيات عامة ---
          // بائعين فريدين
          const vendeursUnique = Array.from(
            new Set(produits.map((p) => p.nameVendeur).filter(Boolean))
          );
          document.getElementById('usersCount').textContent = vendeursUnique.length;

          // عناوين فريدة
          const adressesUnique = Array.from(
            new Set(produits.map((p) => p.adresse).filter(Boolean))
          );
          document.getElementById('adressCount').textContent = `${adressesUnique.length} / 700`;

          // عدد المنتجات
          document.getElementById('productsCount').textContent = produits.length;

          // القيمة الإجمالية
          const totalValue = produits.reduce((s, p) => s + (parseFloat(p.prix) || 0), 0);
          document.getElementById('totalValue').textContent = totalValue.toFixed(2) + ' DH';

          // --- عناوين مشتركة (group by adresse) ---
          const groupedByAdresse = {};
          for (const p of produits) {
            if (!p.adresse) continue;
            if (!groupedByAdresse[p.adresse])
              groupedByAdresse[p.adresse] = { vendeursSet: new Set(), produitsCount: 0 };
            if (p.nameVendeur) groupedByAdresse[p.adresse].vendeursSet.add(p.nameVendeur);
            groupedByAdresse[p.adresse].produitsCount++;
          }

          const sharedEntries = Object.entries(groupedByAdresse)
            .map(([adresse, info]) => ({
              adresse,
              vendeurs: Array.from(info.vendeursSet),
              vendeursCount: info.vendeursSet.size,
              produitsCount: info.produitsCount,
            }))
            .filter((e) => e.vendeursCount > 1)
            .sort((a, b) => b.vendeursCount - a.vendeursCount || b.produitsCount - a.produitsCount);

          document.getElementById('sharedAddresses').textContent = sharedEntries.length;

          // تعبئة جدول العناوين المشتركة
          const tbody = document.querySelector('#sharedTable tbody');
          tbody.innerHTML = sharedEntries
            .map(
              (row) => `
        <tr>
          <td>${escapeHtml(row.adresse)}</td>
          <td>${escapeHtml(row.vendeurs.join(', '))}</td>
          <td>${row.vendeursCount}</td>
        </tr>
      `
            )
            .join('');

          // تهيئة DataTable بأمان (destroy إن كان موجود)
          if ($.fn.dataTable && $.fn.dataTable.isDataTable('#sharedTable')) {
            $('#sharedTable').DataTable().clear().destroy();
          }
          $('#sharedTable').DataTable({
            pageLength: 5,
            responsive: true,
            lengthMenu: [5, 10, 25],
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json' },
          });

          // --- رسم مخطط Top10 vendeurs (Bar vertical) ---
          const vendeursCountMap = {};
          for (const p of produits) {
            if (!p.nameVendeur) continue;
            vendeursCountMap[p.nameVendeur] = (vendeursCountMap[p.nameVendeur] || 0) + 1;
          }
          const top10 = Object.entries(vendeursCountMap)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
          const topLabels = top10.map((v) => v[0]);
          const topValues = top10.map((v) => v[1]);

          // دمر المخطط السابق إن وُجد
          if (window._charts.vendeur) {
            try {
              window._charts.vendeur.destroy();
            } catch (e) {
              /* ignore */
            }
            window._charts.vendeur = null;
          }

          const ctxV = document.getElementById('vendeurChart')?.getContext('2d');
          if (ctxV) {
            window._charts.vendeur = new Chart(ctxV, {
              type: 'bar',
              data: {
                labels: topLabels,
                datasets: [
                  {
                    label: 'Nombre de produits',
                    data: topValues,
                    backgroundColor: [
                      '#1abc9c', // turquoise
                      '#3498db', // blue
                      '#9b59b6', // purple
                      '#e67e22', // orange
                      '#e74c3c', // red
                      '#2ecc71', // green
                      '#16a085', // teal
                      '#f1c40f', // yellow
                      '#2980b9', // deep blue
                      '#8e44ad', // violet
                      '#d35400', // dark orange
                      '#27ae60', // emerald
                      '#c0392b', // dark red
                      '#f39c12', // amber
                      '#7f8c8d', // gray
                    ],

                    borderColor: 'rgba(0,0,0,0.2)',
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    ticks: { autoSkip: true, maxRotation: 45, minRotation: 30, font: { size: 12 } },
                  },
                  y: {
                    beginAtZero: true,
                    ticks: { precision: 0, stepSize: 1 },
                  },
                },
                plugins: {
                  legend: { display: false },
                  title: { display: true, text: 'Top 10 vendeurs (par nombre de produits)' },
                  tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.y} produits` } },
                },
              },
            });
          }

          // --- رسم مخطط العناوين (Horizontal bar ثابت الحد الأقصى = 700) ---
          const adresseCount = adressesUnique.length;

          // دمر المخطط السابق إن وُجد
          if (window._charts.adress) {
            try {
              window._charts.adress.destroy();
            } catch (e) {
              /* ignore */
            }
            window._charts.adress = null;
          }

          const ctxA = document.getElementById('adressChart')?.getContext('2d');
          if (ctxA) {
            window._charts.adress = new Chart(ctxA, {
              type: 'bar',
              data: {
                labels: ['Adresses utilisées', 'Capacité totale'],
                datasets: [
                  {
                    label: 'Adresses',
                    data: [adresseCount, 700],
                    backgroundColor: ['#2575fc', '#4facfe'],
                    borderColor: ['rgba(0,0,0,0.15)', 'rgba(0,0,0,0.15)'],
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                indexAxis: 'y', // يجعل الأعمدة أفقية
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    beginAtZero: true,
                    max: 700,
                    ticks: { stepSize: Math.max(1, Math.ceil(700 / 7)) }, // خطوة مقاربة
                  },
                  y: { grid: { display: false } },
                },
                plugins: {
                  legend: { display: false },
                  title: { display: true, text: 'Utilisation des adresses (sur 700)' },
                  tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.x} adresses` } },
                },
              },
            });
          }
        } catch (err) {
          console.error('Erreur lors du chargement du dashboard:', err);
          const container = document.querySelector('.container-fluid') || document.body;
          const errEl = document.createElement('div');
          errEl.className = 'alert alert-danger mt-3';
          errEl.textContent = 'Erreur lors du chargement du dashboard. Vérifiez la console.';
          container.prepend(errEl);
        }
      }

      document.querySelector('.usersCount').addEventListener('click', () => {
        window.location.href = '/listVendeurs';
      });

      /* شغّل التحميل مرة واحدة عند انتهاء البناء */
      document.addEventListener('DOMContentLoaded', initDashboard);

      // تحديث البيانات كل 5 ثواني
      //setInterval(initDashboard, 5000);
    </script>
  </body>
</html>
